---
import Layout from "../layouts/Layout.astro";
import { ArrowRight } from "lucide-react";
import { getSiteContent } from "../data/site-content";

const content = await getSiteContent();
const page = content.pages.serve;
const joinTeam = page.join_team ?? {
	title: "Join a Team",
	intro:
		"Select the teams you are interested in, then share your contact details. We will follow up with next steps.",
	hero_image: {
		src: "/images/friends.jpg",
		alt: "Church volunteers and friends smiling together outdoors",
	},
	hero_blurb:
		"Serving is one of the best ways to build friendships and help church family thrive each week.",
	steps: {
		select_heading: "1. Select Teams",
		select_intro: "Choose as many teams as you like.",
		details_heading: "2. Your Contact Details",
		preview_heading: "3. Message Preview",
		preview_intro:
			"This message is auto-filled from your selections and details.",
	},
	labels: {
		name: "Name",
		email: "Email",
		phone_optional: "Phone (optional)",
		notes_optional: "Anything else we should know? (optional)",
		submit: "Send Team Interest",
	},
	messages: {
		none_selected: "No teams selected yet.",
		selected_prefix: "Selected teams:",
		message_title: "Join a Team Enquiry",
		teams_label: "Teams interested in",
		name_label: "Name",
		email_label: "Email",
		phone_label: "Phone",
		empty_value: "[not provided]",
		none_selected_short: "None selected",
	},
};
---

<Layout title={joinTeam.title}>
	<div class="max-w-6xl mx-auto px-4 py-20 space-y-8">
		<div class="space-y-3">
			<h1 class="page-heading page-heading--accent text-5xl md:text-6xl font-bold">
				{joinTeam.title}
			</h1>
			<p class="text-xl text-(--ink)/85 max-w-4xl">
				{joinTeam.intro}
			</p>
		</div>
			<section class="grid gap-4 md:grid-cols-[1.2fr_0.8fr]">
				<figure class="theme-card theme-card--strong overflow-hidden">
					<img
						src={joinTeam.hero_image.src}
						alt={joinTeam.hero_image.alt}
						class="w-full h-full min-h-56 object-cover"
						loading="lazy"
					/>
				</figure>
			<div class="theme-drench theme-drench--teal p-6 flex items-center">
				<p class="text-lg text-(--ink)/90 font-medium leading-relaxed">
					{joinTeam.hero_blurb}
				</p>
			</div>
		</section>

		<form
			name="join-team-interest"
			method="POST"
			data-netlify="true"
			netlify-honeypot="bot-field"
			action="/contact-thank-you"
			class="sketch-panel p-6 md:p-8 space-y-6"
		>
			<input type="hidden" name="form-name" value="join-team-interest" />
			<p class="hidden">
				<label>
					Don't fill this out if you're human:
					<input name="bot-field" />
				</label>
			</p>
			<input type="hidden" name="selected_teams" id="selected-teams-field" />

			<div class="space-y-3">
				<h2 class="section-heading text-3xl">{joinTeam.steps.select_heading}</h2>
				<p class="text-(--ink)/85">
					{joinTeam.steps.select_intro}
				</p>
				<div class="grid md:grid-cols-2 gap-4">
					{
						page.teams.map((team) => (
							<button
								type="button"
								data-team-card
								data-team-name={team.name}
								aria-pressed="false"
								class="text-left theme-card theme-card--interactive p-5 transition-colors"
							>
								<p class="section-heading text-2xl mb-2">{team.name}</p>
								<p class="text-(--ink)/85">{team.description}</p>
							</button>
						))
					}
				</div>
				<p id="selected-team-list" class="text-(--ink)/85 font-semibold">
					{joinTeam.messages.none_selected}
				</p>
			</div>

			<div class="space-y-4">
				<h2 class="section-heading text-3xl">{joinTeam.steps.details_heading}</h2>
				<div class="grid md:grid-cols-2 gap-4">
					<label class="block space-y-2">
						<span class="font-semibold text-(--ink)">{joinTeam.labels.name}</span>
						<input
							id="join-team-name"
							type="text"
							name="name"
							required
							class="w-full border-2 border-(--ink) px-3 py-2"
						/>
					</label>
					<label class="block space-y-2">
						<span class="font-semibold text-(--ink)">{joinTeam.labels.email}</span>
						<input
							id="join-team-email"
							type="email"
							name="email"
							required
							class="w-full border-2 border-(--ink) px-3 py-2"
						/>
					</label>
					<label class="block space-y-2 md:col-span-2">
						<span class="font-semibold text-(--ink)">{joinTeam.labels.phone_optional}</span>
						<input
							id="join-team-phone"
							type="tel"
							name="phone"
							class="w-full border-2 border-(--ink) px-3 py-2"
						/>
					</label>
				</div>
			</div>

			<div class="space-y-3">
				<h2 class="section-heading text-3xl">{joinTeam.steps.preview_heading}</h2>
				<p class="text-(--ink)/85">
					{joinTeam.steps.preview_intro}
				</p>
				<textarea
					id="join-team-message"
					name="message"
					required
					rows={8}
					readonly
					class="w-full border-2 border-(--ink) px-3 py-2 bg-white"
				></textarea>
				<label class="block space-y-2">
					<span class="font-semibold text-(--ink)"
						>{joinTeam.labels.notes_optional}</span
					>
					<textarea
						name="additional_notes"
						rows={4}
						class="w-full border-2 border-(--ink) px-3 py-2 bg-white"
					></textarea>
				</label>
			</div>

			<button
				type="submit"
				class="inline-flex items-center gap-2 px-6 py-3 bg-(--ink) text-white border-2 border-(--ink) font-semibold hover:bg-white hover:text-(--ink) transition-colors"
			>
				{joinTeam.labels.submit}
				<ArrowRight size={16} />
			</button>
		</form>
	</div>

		<script is:inline define:vars={{ joinTeamMessages: joinTeam.messages }}>
			(() => {
				const copy = joinTeamMessages;
				const cards = Array.from(
					document.querySelectorAll("[data-team-card]"),
				);
			const selectedTeamsField = document.getElementById(
				"selected-teams-field",
			);
			const selectedTeamList = document.getElementById("selected-team-list");
			const form = document.querySelector("form[name='join-team-interest']");
			const nameInput = document.getElementById("join-team-name");
			const emailInput = document.getElementById("join-team-email");
			const phoneInput = document.getElementById("join-team-phone");
			const messageField = document.getElementById("join-team-message");

			if (
				!selectedTeamsField ||
				!selectedTeamList ||
				!form ||
				!nameInput ||
				!emailInput ||
				!phoneInput ||
				!messageField
			) {
				return;
			}

			const selectedTeams = new Set();

				const renderMessage = () => {
					const teams = Array.from(selectedTeams);
					selectedTeamsField.value = teams.join(", ");

					selectedTeamList.textContent =
						teams.length > 0
							? `${copy.selected_prefix} ${teams.join(", ")}`
							: copy.none_selected;

					messageField.value = [
						copy.message_title,
						"",
						`${copy.teams_label}: ${
							teams.length > 0 ? teams.join(", ") : copy.none_selected_short
						}`,
						`${copy.name_label}: ${nameInput.value.trim() || copy.empty_value}`,
						`${copy.email_label}: ${emailInput.value.trim() || copy.empty_value}`,
						`${copy.phone_label}: ${phoneInput.value.trim() || copy.empty_value}`,
					].join("\n");
				};

			const updateCardStyle = (card, isSelected) => {
				card.setAttribute("aria-pressed", isSelected ? "true" : "false");
				card.style.backgroundColor = isSelected ? "var(--teal-soft)" : "";
				card.style.borderColor = isSelected ? "var(--teal)" : "";
			};

			cards.forEach((card) => {
				card.addEventListener("click", () => {
					const teamName = card.getAttribute("data-team-name") || "";
					if (!teamName) return;

					if (selectedTeams.has(teamName)) {
						selectedTeams.delete(teamName);
						updateCardStyle(card, false);
					} else {
						selectedTeams.add(teamName);
						updateCardStyle(card, true);
					}

					renderMessage();
				});
			});

			[nameInput, emailInput, phoneInput].forEach((input) => {
				input.addEventListener("input", renderMessage);
			});

			form.addEventListener("submit", (event) => {
				if (selectedTeams.size === 0) {
					event.preventDefault();
					selectedTeamList.textContent =
						"Select at least one team before submitting.";
					selectedTeamList.scrollIntoView({
						behavior: "smooth",
						block: "center",
					});
				}
			});

			renderMessage();
		})();
	</script>
</Layout>
