---
import Layout from "../layouts/Layout.astro";
import { getSiteContent } from "../data/site-content";
import { ArrowRight, Calendar, Clock, MapPin } from "lucide-react";
import {
  CALENDAR_URL,
  formatEventDateTimeShort,
  getUpcomingEvents,
} from "../utils/calendar";

const content = await getSiteContent();
const page = content.pages.whats_on;
const upcomingEvents = await getUpcomingEvents(6);
const webcalUrl = CALENDAR_URL.replace(/^https:/, "webcal:");
---

<Layout title={page.title}>
  <div class="max-w-5xl mx-auto px-4 py-20 space-y-10">
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <h1
          class="page-heading page-heading--accent text-5xl md:text-6xl font-bold"
        >
          {page.title}
        </h1>
        <p class="text-(--ink)/80 mt-2">
          {page.subtitle}
        </p>
        <p class="text-(--ink)/80 mt-2">
          {page.what_we_do_link_intro}
          <a
            href={page.what_we_do_link_href}
            class="underline decoration-(--eden) underline-offset-4"
          >
            {page.what_we_do_link_label}
          </a>.
        </p>
      </div>
      <div class="flex flex-wrap gap-3">
        <a
          href={webcalUrl}
          class="inline-flex items-center gap-2 px-4 py-2 bg-white text-(--ink) border-2 border-(--ink) hover:bg-(--ink) hover:text-white transition-colors font-semibold"
        >
          <Calendar size={16} /> {page.import_calendar_label}
        </a>
      </div>
    </div>

    <section id="upcoming-events" class="theme-card p-8 space-y-4">
      <h2 class="section-heading text-3xl mb-1">{page.upcoming_events.heading}</h2>
      <p class="text-(--ink)/90">{page.upcoming_events.description}</p>
      {
        upcomingEvents.length > 0 ? (
          <div class="grid gap-3">
            {upcomingEvents.map((event) => (
              <article class="border-2 border-(--ink) p-4 bg-(--panel-soft)">
                <a
                  href={`/events/${event.slug}`}
                  class="flex items-start gap-4 hover:opacity-80 transition-opacity"
                >
                  <div class="flex-1">
                    <h3 class="text-xl font-bold text-(--ink)">
                      {event.title}
                    </h3>
                    <div class="mt-2 flex flex-col sm:flex-row sm:flex-wrap gap-3 text-(--ink)/85 text-sm font-medium">
                      <span class="inline-flex items-center gap-2">
                        <Clock size={15} />{" "}
                        {formatEventDateTimeShort(event.start, event.timeZone)}
                      </span>
                      {event.location && (
                        <span class="inline-flex items-center gap-2">
                          <MapPin size={15} /> {event.location}
                        </span>
                      )}
                    </div>
                  </div>
                  {event.thumbnailUrl && (
                    <img
                      src={event.thumbnailUrl}
                      alt={`Thumbnail for ${event.title}`}
                      class="w-28 h-20 object-cover border-2 border-(--ink)"
                      loading="lazy"
                    />
                  )}
                </a>
              </article>
            ))}
          </div>
        ) : (
          <p class="text-(--ink)/90">
            {page.upcoming_events.empty_message}
          </p>
        )
      }
      <a
        href="#sunday-gathering"
        class="inline-flex items-center gap-2 font-semibold text-(--ink) hover:text-(--eden) transition-colors"
      >
        {page.upcoming_events.jump_label} <ArrowRight size={16} />
      </a>
    </section>

    <section id="sunday-gathering" class="theme-card p-8">
      <h2 class="section-heading text-3xl mb-3">{page.sunday_gathering.heading}</h2>
      <p class="text-(--ink)/90">
        {page.sunday_gathering.description}
      </p>
      <img
        src={page.sunday_gathering.image.src}
        alt={page.sunday_gathering.image.alt}
        class="w-full h-72 object-cover border-2 border-(--ink) mt-4"
        loading="lazy"
      />
    </section>

    <section id="midweek-prayers" class="theme-card p-8">
      <h2 class="section-heading text-3xl mb-3">{page.midweek_online_prayers.heading}</h2>
      <p class="text-(--ink)/90">
        {page.midweek_online_prayers.description}
      </p>
      <a
        href={page.midweek_online_prayers.zoom_link}
        class="inline-block bg-(--ink) text-white px-4 py-2 font-bold mb-2 hover:bg-(--eden) transition-colors border-2 border-transparent hover:border-(--ink)"
      >
        {page.midweek_online_prayers.button_label}
      </a>
      <p class="text-(--ink)/90 text-sm">
        Meeting ID: <strong>{page.midweek_online_prayers.meeting_id}</strong> | Passcode: <strong
          >{page.midweek_online_prayers.passcode}</strong
        >
      </p>
      <p class="text-(--ink)/90">
        {page.midweek_online_prayers.extra}
      </p>
    </section>

    <section id="foodbank" class="theme-card p-8">
      <h2 class="section-heading text-3xl mb-2">{page.foodbank.heading}</h2>
      <p class="text-(--ink)/90">
        <strong>When:</strong> {page.foodbank.time}
      </p>
      <p class="text-(--ink)/90">
        <strong>Where:</strong> {page.foodbank.where}
      </p>
      <p class="text-(--ink)/90 mb-3">
        <strong>Who:</strong> {page.foodbank.who}
      </p>
      <img
        src={page.foodbank.image.src}
        alt={page.foodbank.image.alt}
        class="w-full h-72 object-cover border-2 border-(--ink) mb-4"
        loading="lazy"
      />
      <p class="mb-3 text-(--ink)/90">
        {page.foodbank.description}
      </p>
      <p class="mb-3 text-(--ink)/90">
        {page.foodbank.referral_policy}
      </p>
      <p class="mb-3 text-(--ink)/90">
        {page.foodbank.support_description}
      </p>
      <p class="text-(--ink)/90 mb-2">
        {page.foodbank.referrals_heading}
      </p>
      <ul class="list-disc pl-6 space-y-1 text-(--ink)/90">
        {page.foodbank.referrals.map((referral) => <li>{referral}</li>)}
      </ul>
      <p class="mt-3 text-(--ink)/90" set:html={page.foodbank.volunteer_html} />
    </section>

    <section id="lunch-club" class="theme-card p-8">
      <h2 class="section-heading text-3xl mb-2">{page.lunch_club.heading}</h2>
      <p class="font-semibold text-(--ink) mb-3">{page.lunch_club.time}</p>
      <p class="text-(--ink)/90">
        {page.lunch_club.description}
      </p>
      <img
        src={page.lunch_club.image.src}
        alt={page.lunch_club.image.alt}
        class="w-full h-72 object-cover border-2 border-(--ink) mt-4"
        loading="lazy"
      />
    </section>

    <section id="seasonal-events" class="theme-card p-8">
      <h2 class="section-heading text-3xl mb-2">{page.seasonal_events.heading}</h2>
      <p class="text-(--ink)/90 mb-4">
        {page.seasonal_events.description}
      </p>
      <div class="grid md:grid-cols-2 gap-4">
        {page.seasonal_events.images.map((image) => (
          <img
            src={image.src}
            alt={image.alt}
            class="w-full h-64 object-cover border-2 border-(--ink)"
            loading="lazy"
          />
        ))}
      </div>
    </section>
  </div>
</Layout>
