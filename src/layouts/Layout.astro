---
import Logo from "../components/Logo.astro";
import { Menu, X } from "lucide-react";
import { getSiteContent } from "../data/site-content";
import "../styles/global.css";

interface Props {
	title: string;
}

const { title } = Astro.props;
const content = await getSiteContent();
const primaryNav = content.navigation.filter(
	(item) =>
		!["/what-we-do#belong", "/what-we-do#serve", "/what-we-do#give"].includes(
			item.href,
		),
);
const utilityNav = content.utility_navigation;
const footerLinks = content.footer.quick_links;
const brand = content.site.brand ?? {
	logo_line_one: "St John's Church",
	logo_line_two: "Park",
	nav_cta_label: "I'm New",
	nav_cta_href: "/im-new",
};
const footerHeading = content.footer.quick_links_heading ?? "Quick Links";
const footerBackgroundImage = content.footer.background_image ?? {
	src: "/images/line-drawing.png",
	alt: "",
};
const rawTheme = (import.meta.env.PUBLIC_SITE_THEME ?? "current").toLowerCase();
const themeAliases: Record<string, "current" | "garden-city" | "line-drawing"> =
	{
		current: "current",
		default: "current",
		"garden-city": "garden-city",
		gardencity: "garden-city",
		garden: "garden-city",
		"line-drawing": "line-drawing",
		linedrawing: "line-drawing",
		art: "line-drawing",
	};
const siteTheme = themeAliases[rawTheme] ?? "current";
---

<!doctype html>
<html lang="en" data-theme={siteTheme}>
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content={content.site.meta_description} />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="alternate icon" href="/favicon.ico" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&family=Caveat:wght@500;600&family=Fraunces:opsz,wght@9..144,600;9..144,700&family=Inter:wght@400;500;600;700;800&family=Manrope:wght@400;500;600;700;800&family=Newsreader:opsz,wght@6..72,500;6..72,700&family=Nunito+Sans:wght@400;600;700;800&display=swap"
			rel="stylesheet"
		/>
		<title>{title} | {content.site.title}</title>
	</head>
	<body class="site-shell text-(--ink)">
		<!-- UTILITY BAR -->
		<div
			class="teal-field text-xs font-semibold py-3 px-4 tracking-wide text-center flex justify-center gap-3"
		>
			{
				utilityNav.map((item) => (
					<a
						href={item.href}
						class={`mission-chip mission-chip--${item.tone}`}
					>
						{item.label}
					</a>
				))
			}
		</div>

		<!-- NAVIGATION -->
		<nav
			class="bg-white/95 backdrop-blur border-b-2 border-(--ink) sticky top-0 z-50"
		>
			<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
				<div class="flex justify-between h-20 items-center">
					<!-- LOGO -->
					<a href="/" class="shrink-0 flex items-center gap-4 group">
						<div
							class="w-12 h-12 text-(--ink) group-hover:text-(--eden) transition-colors"
						>
							<Logo class="w-full h-full" />
						</div>
							<div class="leading-none">
								<span
									class="block font-extrabold text-xl tracking-tight text-(--ink)"
									>{brand.logo_line_one}</span
								>
								<span
									class="block font-semibold text-xl tracking-wide text-(--eden) -mt-1"
									>{brand.logo_line_two}</span
								>
							</div>
						</a>

					<!-- DESKTOP MENU -->
					<div class="hidden md:flex items-center gap-1">
						{
							primaryNav.map((item) => (
								<a
									href={item.href}
									class="text-(--ink) font-semibold text-sm tracking-wide hover:bg-(--paper-line) px-4 py-2 transition-colors"
								>
									{item.label}
								</a>
							))
						}
						<!-- THE GOLDEN TICKET BUTTON -->
							<a
								href={brand.nav_cta_href}
								class="ml-4 bg-(--gold) text-(--ink) px-6 py-2.5 font-semibold text-sm tracking-wide border-2 border-(--ink) hover:bg-white transition-all"
							>
								{brand.nav_cta_label}
							</a>
					</div>

					<!-- MOBILE MENU TOGGLE -->
					<button
						id="mobile-menu-toggle"
						type="button"
						class="md:hidden inline-flex items-center justify-center w-12 h-12 border-2 border-(--ink) text-(--ink) hover:bg-(--ink) hover:text-white transition-colors"
						aria-expanded="false"
						aria-controls="mobile-menu-panel"
						aria-label="Toggle navigation menu"
					>
						<Menu data-menu-icon-open size={22} />
						<X data-menu-icon-close size={22} className="hidden" />
					</button>
				</div>
			</div>

			<div
				id="mobile-menu-panel"
				class="hidden md:hidden border-t-2 border-(--ink) bg-white"
			>
				<div class="px-4 py-4 flex flex-col gap-2">
					{
						primaryNav.map((item) => (
							<a
								data-mobile-link
								href={item.href}
								class="text-(--ink) font-semibold text-base tracking-wide border-2 border-transparent hover:border-(--ink) px-3 py-2 transition-colors"
							>
								{item.label}
							</a>
						))
					}
						<a
							data-mobile-link
							href={brand.nav_cta_href}
							class="mt-2 bg-(--gold) text-(--ink) px-4 py-2.5 font-semibold text-sm tracking-wide border-2 border-(--ink) hover:bg-white transition-all inline-flex w-fit"
						>
							{brand.nav_cta_label}
						</a>
				</div>
			</div>
		</nav>

		<script is:inline>
			(() => {
				const toggle = document.getElementById("mobile-menu-toggle");
				const panel = document.getElementById("mobile-menu-panel");
				if (!toggle || !panel) return;

				const openIcon = toggle.querySelector("[data-menu-icon-open]");
				const closeIcon = toggle.querySelector(
					"[data-menu-icon-close]",
				);
				const links = panel.querySelectorAll("a[data-mobile-link]");

				const setOpen = (isOpen) => {
					toggle.setAttribute(
						"aria-expanded",
						isOpen ? "true" : "false",
					);
					panel.classList.toggle("hidden", !isOpen);
					openIcon?.classList.toggle("hidden", isOpen);
					closeIcon?.classList.toggle("hidden", !isOpen);
				};

				setOpen(false);

				toggle.addEventListener("click", () => {
					const expanded =
						toggle.getAttribute("aria-expanded") === "true";
					setOpen(!expanded);
				});

				links.forEach((link) => {
					link.addEventListener("click", () => setOpen(false));
				});

				window.addEventListener("resize", () => {
					if (window.innerWidth >= 768) {
						setOpen(false);
					}
				});
			})();
		</script>

		<slot />

		<!-- FOOTER -->
			<footer
				class="themed-footer py-16 mt-auto border-t-2 border-(--ink) relative overflow-hidden text-white"
			>
				<img
					src={footerBackgroundImage.src}
					alt={footerBackgroundImage.alt}
					aria-hidden="true"
					class="absolute -top-3 left-0 w-full opacity-[0.15] pointer-events-none"
				/>
			<div
				class="max-w-7xl mx-auto px-4 grid md:grid-cols-2 gap-12 relative z-10"
			>
				<div>
					<div class="w-16 h-16 text-(--gold) mb-6">
						<Logo class="w-full h-full" />
					</div>
					<h3 class="text-2xl font-bold tracking-wide mb-2">
						{content.footer.title}
					</h3>
					<p class="text-white/80 max-w-sm">{content.site.address}</p>
				</div>
					<div class="md:text-right">
						<p class="font-semibold text-(--gold) tracking-wide mb-4">
							{footerHeading}
						</p>
					<div class="flex flex-col md:items-end gap-2 text-white/85">
						{
							footerLinks.map((item) => (
								<a
									href={item.href}
									class="hover:text-white hover:underline decoration-(--gold) underline-offset-4"
								>
									{item.label}
								</a>
							))
						}
					</div>
				</div>
			</div>
		</footer>
	</body>
</html>
